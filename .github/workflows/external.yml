name: External tests

on:
  workflow_dispatch:
    inputs:
      nodes:
        description: "Number of provider nodes"
        required: true
        default: "10"
      central_net_host:
        description: "Central net host"
        required: false
        default: "polygongas.org:6999"

concurrency:
  group: external-tests

jobs:
  before:
    name: Prepare external test environment
    runs-on: ubuntu-latest
    steps:
      - name: Delete external offers (from previous runs)
        run: |
          curl -X POST http://polygongas.org:11500/offers/clear

  provider:
    name: Provider part - ${{ github.event.inputs.nodes }} nodes
    timeout-minutes: 20
    runs-on: salad-prov
    needs: before
    strategy:
      fail-fast: false
      matrix:
        provider_group: [0]

    steps:
      - name: Wait
        run: |
          sleep $(( ${{ matrix.provider_group }} * 4 ))

      - name: Checkout
        uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Setup providers
        run: |
          (cd integration && ./setup_provider.sh ${{ github.event.inputs.nodes }})
        env:
          YAGNA_VERSION: "pre-rel-v0.17.6-preview.noarkiv.14"
          CENTRAL_NET_HOST: "${{ github.event.inputs.central_net_host }}"
          OFFER_SERVER: "http://polygongas.org:11500"
          MACHINE_PROV: "gth${{ matrix.provider_group }}"

      - name: Start providers
        run: |
          (cd integration && ./start_and_detach_provider.sh ${{ github.event.inputs.nodes }})
        env:
          MACHINE_PROV: "gth${{ matrix.provider_group }}"

      - name: Wait for other tests
        run: |
          sleep 120

      - name: Kill services
        if: always()
        run: |
          (cd integration && ./kill_all.sh ${{ github.event.inputs.nodes }})
        env:
          MACHINE_PROV: "gth${{ matrix.provider_group }}"

      - name: Logging
        if: always()
        run: |
          (cd integration && ./collect_logs.sh ${{ github.event.inputs.nodes }})
        env:
          MACHINE_PROV: "gth${{ matrix.provider_group }}"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: provider-logs-${{ matrix.provider_group }}-${{ github.event.inputs.nodes }}
          path: 'integration/all-logs.tar.gz'

  requestor:
    name: Requestor part
    timeout-minutes: 20
    runs-on: ubuntu-latest
    needs: before
    strategy:
      fail-fast: false
      matrix:
        requestor_group: [0]

    steps:
      - name: Wait
        run: |
          sleep $(( ${{ matrix.requestor_group }} * 4 ))

      - name: Checkout
        uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Build
        run: cargo build -p yagna-offer-server

      - name: Prepare python venv
        run: |
          (cd integration && ./prepare_python.sh)

      - name: Setup requestor
        run: |
          (cd integration && ./setup_requestor.sh)
        env:
          YAGNA_VERSION: "pre-rel-v0.17.6-preview.noarkiv.14"
          CENTRAL_NET_HOSTS: "${{ github.event.inputs.central_net_host }}"

      - name: Start services
        run: |
          (cd integration && ./start_and_detach_requestor.sh)
        env:
          PICK_OFFERS_INTERVAL_SECS: "0.1"
          OFFER_SOURCE_URL: "http://polygongas.org:11500/offers/list"
          OFFER_MIRROR_SYNC_INTERVAL_SECS: "10"
          OFFER_GROUP: "gth${{ matrix.requestor_group }}"

      - name: Wait for providers to be online
        run: |
          set -e
          
          until (cd integration && python count_offers.py \
            --url "$OFFER_SOURCE_URL" \
            --expected-count ${{ github.event.inputs.nodes }} \
            --name-filter "^$OFFER_GROUP-"); do
            echo "Providers not ready yet, retrying in 10 seconds..."
            sleep 10
          done
          
          echo "Providers are online ðŸŽ‰"
        env:
          OFFER_SOURCE_URL: "http://polygongas.org:11500/offers/list"
          OFFER_GROUP: "gth${{ matrix.requestor_group }}"

      - name: Check rentals
        run: |
          sleep 30
          (cd integration && ./show_rentals.sh ${{ github.event.inputs.nodes }})

      - name: Show offers
        if: always()
        run: |
          curl http://127.0.0.1:15155/offers/list | jq

      - name: Show demands
        if: always()
        run: |
          curl http://127.0.0.1:15155/requestor/demands/list | jq

      - name: Kill services
        if: always()
        run: |
          (cd integration && ./kill_all.sh ${{ github.event.inputs.nodes }})

      - name: Logging
        if: always()
        run: |
          (cd integration && ./collect_logs.sh ${{ github.event.inputs.nodes }})

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: requestor-logs-${{ matrix.requestor_group }}-${{ github.event.inputs.nodes }}
          path: 'integration/all-logs.tar.gz'